
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>OC INWENTARYZACJA LIVE</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; padding: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 12px; text-align: center; border: 1px solid #ccc; }
    th { background: #2196f3; color: white; }
    .proposed-box {
  padding: 6px 10px;
  margin-top: 6px;
  border-radius: 6px;
  font-size: 14px;
  border: 1px solid transparent;
}
.proposed-box.add {
  background: #e8f5e9;
  border-color: #4caf50;
}
.proposed-box.sub {
  background: #ffebee;
  border-color: #c62828;
}
      border: 1px solid #2196f3;
      padding: 6px 10px;
      margin-top: 6px;
      border-radius: 6px;
      background: #e3f2fd;
    }
    .proposed-box span {
      font-weight: bold;
      font-size: 16px;
      color: #0d47a1;
    }
    .pulse { animation: pulse 0.6s ease; }
    @keyframes pulse {
      0% { background-color: #e3f2fd; }
      50% { background-color: #bbdefb; }
      100% { background-color: #e3f2fd; }
    }
    button {
      border: none; padding: 6px 10px; border-radius: 6px;
      font-size: 14px; margin: 2px; cursor: pointer;
    }
    .plus { background: #4caf50; color: white; }
    .minus { background: #f44336; color: white; }
    .confirm { background: #2196f3; color: white; }
    .reset { background: #9e9e9e; color: white; }
  </style>
</head>
<body>
  <h1>OC INWENTARYZACJA ‚Äî LIVE DATA</h1>
  <table>
    <thead>
      <tr><th>MODEL</th><th>PN</th><th>ILO≈öƒÜ</th><th>EDYCJA</th></tr>
    </thead>
    <tbody id="table-body">
      <tr><td colspan="4">‚è≥ ≈Åadowanie danych...</td></tr>
    </tbody>
  </table>

  <div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:20px 30px; border-radius:10px; text-align:center;">
      <p style="font-size:16px; font-weight:bold; color:#e65100;">‚ùó Czy na pewno chcesz dodaƒá <span id="modal-qty">X</span> sztuk?</p>
      <div style="margin-top: 15px;">
        <button id="modal-confirm">Tak</button>
        <button id="modal-cancel">Anuluj</button>
      </div>
    </div>
  </div>

<script>
const apiUrl = "https://wispy-waterfall-e267.lukaszarmiajotpe.workers.dev/";
const postUrl = "https://script.google.com/macros/s/AKfycbxe4JpyDE_TG2tjMHfZDnyrh6_Mr_SLHK_pvqf07gwNLde_rHDFGMEaBKnKt0tfj4SBUQ/exec";

let currentData = [];
let proposedQtyMap = {};
let pendingIndex = null;
let pendingAddQty = 0;

function renderTable(data) {
  const tableBody = document.getElementById("table-body");
  tableBody.innerHTML = "";
  data.forEach((row, index) => {
    let html = `<tr id="row-${index}">`;
    html += `<td>${row["MODEL"]}</td>`;
    html += `<td>${row["PN"]}</td>`;
    html += `<td>
      <div><span id="qty-${index}">${row["ILO≈öƒÜ"]}</span></div>
      <div class="proposed-box" id="proposed-wrapper-${index}">
        <strong>DO DODANIA:</strong>
        <span id="proposed-${index}">0</span>
      </div>
    </td>`;
    html += `<td>
      <button class="minus" onclick="changeQty(${index}, -1)">‚ûñ</button>
      <button class="plus" onclick="changeQty(${index}, 1)">‚ûï</button>
      <button class="confirm" onclick="confirmQty(${index})">‚úîÔ∏è</button>
      <button class="reset" onclick="resetQty(${index})">‚úñÔ∏è</button>
    </td>`;
    html += "</tr>";
    tableBody.innerHTML += html;
  });
}

function changeQty(index, delta) {
  if (!proposedQtyMap[index]) proposedQtyMap[index] = 0;
  proposedQtyMap[index] += delta;
  if (proposedQtyMap[index] < 0) proposedQtyMap[index] = 0;
  const el = document.getElementById(`proposed-${index}`);
  if (el) {
    
  el.textContent = proposedQtyMap[index];
  const box = document.getElementById(`proposed-wrapper-${index}`);
  if (box) {
    box.classList.add("pulse");
    setTimeout(() => box.classList.remove("pulse"), 600);
    if (proposedQtyMap[index] > 0) {
      box.className = 'proposed-box add';
    box.innerHTML = 'üü¢ <strong>DO DODANIA:</strong> <span id="proposed-' + index + '">' + proposedQtyMap[index] + '</span>';
    } else {
      box.className = 'proposed-box sub';
    box.innerHTML = 'üî¥ <strong>DO ODJƒòCIA:</strong> <span id="proposed-' + index + '">' + Math.abs(proposedQtyMap[index]) + '</span>';
    }
  }
  
    const box = document.getElementById(`proposed-wrapper-${index}`);
    if (box) {
      box.classList.add("pulse");
      setTimeout(() => box.classList.remove("pulse"), 600);
    }
  }
}

function resetQty(index) {
  proposedQtyMap[index] = 0;
  const el = document.getElementById(`proposed-${index}`);
  if (el) el.textContent = "0";
}

function confirmQty(index) {
  
  const add = proposedQtyMap[index] || 0;
  if (add === 0) return;
  const qtyText = add > 0 ? `dodaƒá ${add} sztuk` : `odjƒÖƒá ${Math.abs(add)} sztuk`;
  document.getElementById("modal-qty").textContent = qtyText;
  
  if (add <= 0) return;
  document.getElementById("modal-qty").textContent = add;
  document.getElementById("confirm-modal").style.display = "flex";
  pendingIndex = index;
  pendingAddQty = add;
}

document.getElementById("modal-confirm").addEventListener("click", () => {
  const index = pendingIndex;
  const add = pendingAddQty;
  const base = parseInt(document.getElementById(`qty-${index}`).textContent);
  
  const finalQty = base + add;
  if (finalQty < 0) {
    alert("‚ùå Nie mo≈ºna odjƒÖƒá wiƒôcej ni≈º aktualna ilo≈õƒá!");
    document.getElementById("confirm-modal").style.display = "none";
    return;
  }
  
  document.getElementById(`qty-${index}`).textContent = finalQty;
  document.getElementById(`proposed-${index}`).textContent = "0";
  proposedQtyMap[index] = 0;
  document.getElementById("confirm-modal").style.display = "none";

  const row = currentData[index];
  const payload = [{
    MODEL: row["MODEL"],
    PN: row["PN"],
    ILO≈öƒÜ: finalQty,
    updated: new Date().toLocaleString()
  }];

  fetch(postUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(() => console.log("[‚úîÔ∏è] Dane wys≈Çane:", payload))
    .catch(err => console.error("‚ùå B≈ÇƒÖd zapisu:", err));
});

document.getElementById("modal-cancel").addEventListener("click", () => {
  document.getElementById("confirm-modal").style.display = "none";
  pendingIndex = null;
  pendingAddQty = 0;
});

async function loadData() {
  const res = await fetch(apiUrl);
  const data = await res.json();
  currentData = data;
  renderTable(data);
}
loadData();
</script>
</body>
</html>
